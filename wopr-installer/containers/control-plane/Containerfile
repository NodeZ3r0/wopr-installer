# WOPR Control Plane Container
# =============================
# Orchestrates VPS provisioning, handles Stripe webhooks, manages beacons
#
# Build: podman build -t wopr-control-plane -f containers/control-plane/Containerfile .
# Run:   podman run -d --name wopr-orc -p 8001:8001 --env-file .env wopr-control-plane

FROM docker.io/python:3.12-slim-bookworm

LABEL org.opencontainers.image.title="WOPR Control Plane"
LABEL org.opencontainers.image.description="Orchestrates WOPR beacon provisioning and management"
LABEL org.opencontainers.image.vendor="WOPR Systems"
LABEL org.opencontainers.image.source="https://vault.wopr.systems/wopr/wopr-installer"

# Build args for versioning
ARG VERSION=1.0.0
ARG BUILD_DATE
ARG GIT_COMMIT

LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${GIT_COMMIT}"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    jq \
    ca-certificates \
    # For PDF generation (WeasyPrint)
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf2.0-0 \
    libffi-dev \
    shared-mime-info \
    # For healthchecks
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r wopr && useradd -r -g wopr -d /app -s /sbin/nologin wopr

# Set working directory
WORKDIR /app

# Copy requirements first (for layer caching)
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY main.py .
COPY control_plane/ ./control_plane/
COPY templates/ ./templates/

# Copy static files for dashboard (if they exist)
COPY dashboard/build/ ./dashboard/build/ 2>/dev/null || true

# Create directories for runtime data
RUN mkdir -p /var/lib/wopr/jobs /var/lib/wopr/documents /var/log/wopr \
    && chown -R wopr:wopr /var/lib/wopr /var/log/wopr /app

# Copy entrypoint script
COPY containers/control-plane/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Switch to non-root user
USER wopr

# Environment defaults
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV LOG_LEVEL=INFO
ENV LOG_FORMAT=json
ENV JOB_STORE_PATH=/var/lib/wopr/jobs
ENV DOCUMENT_OUTPUT_DIR=/var/lib/wopr/documents

# Expose API port
EXPOSE 8001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -sf http://localhost:8001/api/health || exit 1

# Entry point
ENTRYPOINT ["/entrypoint.sh"]
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001", "--workers", "2"]
