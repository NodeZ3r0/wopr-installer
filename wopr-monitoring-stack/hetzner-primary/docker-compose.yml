version: "3.8"

# WOPR Full Monitoring Stack - Hetzner Primary
# Grafana + Prometheus + Loki + Alertmanager + ntfy + Umami + Uptime Kuma + ntopng

networks:
  monitoring:
    driver: bridge
  nebula:
    external: true  # Your existing Nebula network

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
  alertmanager-data:
  ntfy-data:
  umami-db-data:
  uptime-kuma-data:
  ntopng-data:

services:

  # ═══════════════════════════════════════════════════════════════
  # PROMETHEUS - Metrics Collection
  # ═══════════════════════════════════════════════════════════════
  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=90d'
      - '--storage.tsdb.retention.size=50GB'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    networks:
      - monitoring
      - nebula

  # ═══════════════════════════════════════════════════════════════
  # ALERTMANAGER - Alert Routing (to ntfy + SMTP)
  # ═══════════════════════════════════════════════════════════════
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - monitoring

  # ═══════════════════════════════════════════════════════════════
  # GRAFANA - Visualization
  # ═══════════════════════════════════════════════════════════════
  grafana:
    image: grafana/grafana-oss:10.3.1
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://grafana.wopr.systems
      GF_SERVER_DOMAIN: grafana.wopr.systems
      # SMTP for Grafana native alerts
      GF_SMTP_ENABLED: "true"
      GF_SMTP_HOST: ${SMTP_HOST}:${SMTP_PORT}
      GF_SMTP_USER: ${SMTP_USER}
      GF_SMTP_PASSWORD: ${SMTP_PASSWORD}
      GF_SMTP_FROM_ADDRESS: ${SMTP_FROM}
      GF_SMTP_FROM_NAME: "DEFCON ONE Monitoring"
      # Theme - dark by default
      GF_USERS_DEFAULT_THEME: dark
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      # Plugins
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-piechart-panel,grafana-worldmap-panel
      # External links in navbar
      GF_PANELS_DISABLE_SANITIZE_HTML: "true"
      # Custom branding
      GF_UI_BRANDING_LOGIN_LOGO: ""
      GF_UI_BRANDING_MENU_LOGO: ""
      GF_UI_BRANDING_LOGIN_BACKGROUND: ""
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - monitoring
    depends_on:
      - prometheus
      - loki

  # ═══════════════════════════════════════════════════════════════
  # LOKI - Log Aggregation
  # ═══════════════════════════════════════════════════════════════
  loki:
    image: grafana/loki:2.9.4
    container_name: loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/config.yml
    networks:
      - monitoring
      - nebula

  # ═══════════════════════════════════════════════════════════════
  # PROMTAIL - Log Shipper (Local)
  # ═══════════════════════════════════════════════════════════════
  promtail:
    image: grafana/promtail:2.9.4
    container_name: promtail
    restart: unless-stopped
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring

  # ═══════════════════════════════════════════════════════════════
  # NODE EXPORTER - System Metrics
  # ═══════════════════════════════════════════════════════════════
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node-exporter
    restart: unless-stopped
    pid: host
    network_mode: host
    command:
      - '--path.rootfs=/host'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--collector.netclass.ignored-devices=^(veth.*|docker.*|br-.*)$$'
    volumes:
      - '/:/host:ro,rslave'

  # ═══════════════════════════════════════════════════════════════
  # NTFY - Push Notifications
  # ═══════════════════════════════════════════════════════════════
  ntfy:
    image: binwiederhier/ntfy:v2.8.0
    container_name: ntfy
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./ntfy/server.yml:/etc/ntfy/server.yml:ro
      - ntfy-data:/var/lib/ntfy
    command: serve
    networks:
      - monitoring

  # ═══════════════════════════════════════════════════════════════
  # UMAMI - Web Analytics
  # ═══════════════════════════════════════════════════════════════
  umami-db:
    image: postgres:16-alpine
    container_name: umami-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: ${UMAMI_DB_PASSWORD}
    volumes:
      - umami-db-data:/var/lib/postgresql/data
    networks:
      - monitoring

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: umami
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://umami:${UMAMI_DB_PASSWORD}@umami-db:5432/umami
      APP_SECRET: ${UMAMI_APP_SECRET}
    ports:
      - "3001:3000"
    depends_on:
      - umami-db
    networks:
      - monitoring

  # ═══════════════════════════════════════════════════════════════
  # UPTIME KUMA - Uptime Monitoring
  # ═══════════════════════════════════════════════════════════════
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3002:3001"
    volumes:
      - uptime-kuma-data:/app/data
    networks:
      - monitoring

  # ═══════════════════════════════════════════════════════════════
  # NTOPNG - Network Traffic Analysis
  # ═══════════════════════════════════════════════════════════════
  ntopng:
    image: ntop/ntopng:stable
    container_name: ntopng
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    volumes:
      - ntopng-data:/var/lib/ntopng
    command:
      - '--community'
      - '-i=eth0'
      - '-w=3003'

  # ═══════════════════════════════════════════════════════════════
  # CADDY EXPORTER - Caddy Metrics
  # ═══════════════════════════════════════════════════════════════
  caddy-exporter:
    image: caddy/caddy:2-alpine
    container_name: caddy-exporter
    restart: unless-stopped
    network_mode: host
    # Note: Caddy exposes metrics on :2019/metrics by default when configured

  # ═══════════════════════════════════════════════════════════════
  # DEFCON DASHBOARD - Custom Frontend
  # ═══════════════════════════════════════════════════════════════
  defcon-dashboard:
    build:
      context: ../defcon-dashboard
      dockerfile: Dockerfile
    container_name: defcon-dashboard
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      PROMETHEUS_URL: http://prometheus:9090
      LOKI_URL: http://loki:3100
      ALERTMANAGER_URL: http://alertmanager:9093
      NTFY_URL: http://ntfy:80
    networks:
      - monitoring
    depends_on:
      - prometheus
      - loki
      - alertmanager