# WOPR Alertmanager Configuration
# Routes alerts to ntfy (push notifications) and SMTP (email)

global:
  # SMTP settings for email alerts
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${SMTP_FROM}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack-style webhook timeout (used by ntfy)
  slack_api_url: 'http://ntfy:80'

# Alert templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing tree
route:
  # Default receiver
  receiver: 'defcon-all'

  # Group alerts by these labels
  group_by: ['alertname', 'instance', 'severity', 'defcon']

  # Wait before sending first notification
  group_wait: 30s

  # Wait before sending notification about new alerts in group
  group_interval: 5m

  # Resend interval for unresolved alerts
  repeat_interval: 4h

  # Child routes for different severity levels
  routes:
    # DEFCON 1 - Critical: ntfy + email immediately
    - match:
        defcon: "1"
      receiver: 'defcon-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # DEFCON 2 - High: ntfy + email
    - match:
        defcon: "2"
      receiver: 'defcon-high'
      group_wait: 30s
      repeat_interval: 2h
      continue: true

    # DEFCON 3-4 - Warning: ntfy only
    - match_re:
        defcon: "3|4"
      receiver: 'defcon-warning'
      repeat_interval: 6h

    # DEFCON 5 - Info: ntfy low priority
    - match:
        defcon: "5"
      receiver: 'defcon-info'
      repeat_interval: 24h

# Inhibition rules - suppress lower severity alerts when critical is firing
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  - source_match:
      severity: 'critical'
    target_match:
      severity: 'info'
    equal: ['alertname', 'instance']

# Receivers
receivers:
  # Default receiver - both ntfy and email
  - name: 'defcon-all'
    webhook_configs:
      - url: 'http://ntfy:80/wopr-alerts'
        send_resolved: true
        http_config:
          headers:
            Title: 'WOPR Alert: {{ .GroupLabels.alertname }}'
            Priority: 'default'
            Tags: 'warning,wopr'

  # DEFCON 1 - Critical alerts
  - name: 'defcon-critical'
    webhook_configs:
      - url: 'http://ntfy:80/wopr-critical'
        send_resolved: true
        http_config:
          headers:
            Title: 'DEFCON 1: {{ .GroupLabels.alertname }}'
            Priority: 'urgent'
            Tags: 'rotating_light,skull'
    email_configs:
      - to: '${ALERT_EMAIL}'
        headers:
          Subject: '[DEFCON 1] CRITICAL: {{ .GroupLabels.alertname }} on {{ .GroupLabels.instance }}'
        html: |
          <h2 style="color: #ff4444;">DEFCON 1 - CRITICAL ALERT</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          {{ range .Alerts }}
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Runbook:</strong> {{ .Annotations.runbook }}</p>
          {{ end }}
          <hr>
          <p style="color: #666;">WOPR DEFCON ONE Monitoring System</p>

  # DEFCON 2 - High priority
  - name: 'defcon-high'
    webhook_configs:
      - url: 'http://ntfy:80/wopr-alerts'
        send_resolved: true
        http_config:
          headers:
            Title: 'DEFCON 2: {{ .GroupLabels.alertname }}'
            Priority: 'high'
            Tags: 'warning,fire'
    email_configs:
      - to: '${ALERT_EMAIL}'
        headers:
          Subject: '[DEFCON 2] WARNING: {{ .GroupLabels.alertname }} on {{ .GroupLabels.instance }}'

  # DEFCON 3-4 - Warning (ntfy only)
  - name: 'defcon-warning'
    webhook_configs:
      - url: 'http://ntfy:80/wopr-alerts'
        send_resolved: true
        http_config:
          headers:
            Title: 'DEFCON {{ .GroupLabels.defcon }}: {{ .GroupLabels.alertname }}'
            Priority: 'default'
            Tags: 'triangular_flag_on_post'

  # DEFCON 5 - Informational
  - name: 'defcon-info'
    webhook_configs:
      - url: 'http://ntfy:80/wopr-info'
        send_resolved: false
        http_config:
          headers:
            Title: 'WOPR Info: {{ .GroupLabels.alertname }}'
            Priority: 'low'
            Tags: 'information_source'